<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Overlay</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
        }

        #mask {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.14);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: crosshair;
        }

        #center {
            color: white;
            font-size: 56px;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.28);
            padding: 24px 40px;
            border-radius: 10px;
            pointer-events: none;
        }

        #selection {
            position: absolute;
            border: 2px dashed rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.04);
            border-radius: 4px;
            pointer-events: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>

<body>
    <div id="mask">
        <div id="center">hello</div>
        <div id="selection" style="display:none"></div>
    </div>

    <script type="module">
        import { WebviewWindow } from '@tauri-apps/api/window';

        function restoreAndClose(payload) {
            try {
                const main = WebviewWindow.getByLabel('main');
                if (main) {
                    main.show();
                    // focus main window
                    main.rpc?.notify?.('focus') || main.show();
                }
            } catch (e) {
                console.warn('could not show main window', e);
            }
            // optionally pass payload back to main via event
            if (payload) {
                try {
                    // dynamic import event emitter
                    import('@tauri-apps/api/event').then(({ emit }) => {
                        // emit global event - listeners in main window can receive
                        emit('screenshot-selection', payload).catch(() => { });
                    }).catch(() => { });
                } catch (e) { }
            }
            window.close();
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') restoreAndClose();
        });

        // Dismiss when clicking on the mask (not the center element)
        const mask = document.getElementById('mask');
        const selectionEl = document.getElementById('selection');
        mask?.addEventListener('click', (e) => {
            const target = e.target;
            if (target && (target.id === 'mask')) {
                restoreAndClose();
            }
        });

        // Drag-to-select logic
        let dragging = false;
        let startX = 0, startY = 0;

        function toClientXY(e) {
            if ('touches' in e && e.touches && e.touches.length) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        mask?.addEventListener('mousedown', (e) => {
            const t = toClientXY(e);
            dragging = true;
            startX = t.x;
            startY = t.y;
            if (selectionEl) {
                selectionEl.style.display = 'block';
                selectionEl.style.left = startX + 'px';
                selectionEl.style.top = startY + 'px';
                selectionEl.style.width = '0px';
                selectionEl.style.height = '0px';
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            const t = toClientXY(e);
            const x = Math.min(t.x, startX);
            const y = Math.min(t.y, startY);
            const w = Math.abs(t.x - startX);
            const h = Math.abs(t.y - startY);
            if (selectionEl) {
                selectionEl.style.left = x + 'px';
                selectionEl.style.top = y + 'px';
                selectionEl.style.width = w + 'px';
                selectionEl.style.height = h + 'px';
                selectionEl.style.display = w && h ? 'block' : 'none';
            }
        });

        window.addEventListener('mouseup', (e) => {
            if (!dragging) return;
            dragging = false;
            const t = toClientXY(e);
            const x = Math.min(t.x, startX);
            const y = Math.min(t.y, startY);
            const w = Math.abs(t.x - startX);
            const h = Math.abs(t.y - startY);
            if (selectionEl) selectionEl.style.display = 'none';

            // Emit selection coordinates and close
            const payload = { x, y, w, h, screenW: window.innerWidth, screenH: window.innerHeight };
            try {
                // try to notify main window and close
                restoreAndClose(payload);
            } catch (err) {
                console.warn('restoreAndClose failed', err);
                restoreAndClose();
            }
        });

        // If the overlay is closed from native side, try to restore main as a fallback
        window.addEventListener('beforeunload', () => {
            try { const main = WebviewWindow.getByLabel('main'); if (main) main.show(); } catch (e) { }
        });
    </script>
</body>

</html>